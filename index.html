<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"alstonzero.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MyNote">
<meta property="og:url" content="https://alstonzero.github.io/index.html">
<meta property="og:site_name" content="MyNote">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="HOU YINGQIAO">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://alstonzero.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>MyNote</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MyNote</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/alstonzero" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/12/30/Kubernetes%20%E3%81%AE%E5%9F%BA%E7%A4%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/30/Kubernetes%20%E3%81%AE%E5%9F%BA%E7%A4%8E/" class="post-title-link" itemprop="url">Kubernetes の基礎</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-30 22:27:29" itemprop="dateCreated datePublished" datetime="2020-12-30T22:27:29+09:00">2020-12-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-31 11:54:27" itemprop="dateModified" datetime="2020-12-31T11:54:27+09:00">2020-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s%E3%82%AC%E3%82%A4%E3%83%89%E3%83%96%E3%83%83%E3%82%AF/" itemprop="url" rel="index"><span itemprop="name">k8sガイドブック</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Kubernetes-の基礎"><a href="#Kubernetes-の基礎" class="headerlink" title="Kubernetes の基礎"></a>Kubernetes の基礎</h2><p>Kubernetes は、Kubernetes Master と Kubernetes Node の 2 種類のノードから成り立っています。</p>
<p><img src="C:\Users\alston\AppData\Roaming\Typora\typora-user-images\1609320771787.png" alt="1609320771787"></p>
<p>CLI ツールのkubectl はマニフェストファイル（<code>.yaml</code>,<code>.yml</code>,<code>.json</code>）の情報を元にKubernetes Master が持つ API にリクエストを送ることで Kubernetes を操作します。</p>
<p>また、Kubernetes　Master の API は、一般的な RESTful API として実装されているので、各種プログラム言語の RESTful API ライブラリや<code> curl</code> などのコマンドラインツールを利用して、直接 API を呼び出して Kubernetes を操作することも可能です。</p>
<h3 id="Kubernetes-とリソース"><a href="#Kubernetes-とリソース" class="headerlink" title="Kubernetes とリソース"></a>Kubernetes とリソース</h3><p><img src="C:\Users\alston\AppData\Roaming\Typora\typora-user-images\1609321734245.png" alt="1609321734245"></p>
<h4 id="Workloads-APIs-リソースがあります"><a href="#Workloads-APIs-リソースがあります" class="headerlink" title="Workloads APIs リソースがあります"></a>Workloads APIs リソースがあります</h4><p>● Pod<br>● ReplicationController<br>● ReplicaSet<br>● Deployment<br>● DaemonSet<br>● StatefulSet<br>● Job<br>● CronJob</p>
<h4 id="Service-APIs-カテゴリ"><a href="#Service-APIs-カテゴリ" class="headerlink" title="Service APIs カテゴリ"></a>Service APIs カテゴリ</h4><p>Service APIs カテゴリは、コンテナのサービスディスカバリや、クラスタの外部からもア<br>クセス可能なエンドポイントなどを提供するリソースです。</p>
<p>● Service<br>・ ClusterIP<br>・ ExternalIP（ClusterIP の一種）<br>・ NodePort<br>・ LoadBalancer<br>・ Headless（None）<br>・ ExternalName<br>・ None-Selector<br>● Ingres</p>
<h4 id="Config-＆-Storage-APIs-カテゴリ"><a href="#Config-＆-Storage-APIs-カテゴリ" class="headerlink" title="Config ＆ Storage APIs カテゴリ"></a>Config ＆ Storage APIs カテゴリ</h4><p>Config ＆ Storage APIs カテゴリは、設定や機密データをコンテナに埋め込んだり、永続ボリュームを提供するリソースです。</p>
<p>● Secret<br>● ConfigMap<br>● PersistentVolumeClaim</p>
<h4 id="Cluster-APIs-カテゴリ"><a href="#Cluster-APIs-カテゴリ" class="headerlink" title="Cluster APIs カテゴリ"></a>Cluster APIs カテゴリ</h4><p>クラスタ自体の振る舞いを定義するリソースです。セキュリティ周りの設定やポリシー、クラスタの管理性を高める機能のためのリソースなど、様々なリソースがあります。</p>
<p>● Node<br>● Namespace<br>● PersistentVolume<br>● ResourceQuota<br>● ServiceAccount<br>● Role<br>● ClusterRole<br>● RoleBinding<br>● ClusterRoleBinding<br>● NetworkPolicy</p>
<h4 id="Metadata-APIs-カテゴリ"><a href="#Metadata-APIs-カテゴリ" class="headerlink" title="Metadata APIs カテゴリ"></a>Metadata APIs カテゴリ</h4><p>クラスタ内の他のリソースの動作を制御するためのリソースです。</p>
<p>例えば、Pod をオートスケーリングさせるために利用される HorizontalPodAutoscaler は、Deployment リソースを操作してレプリカ数を変更することでオートスケーリングを実現しています。</p>
<p>● LimitRange<br>● HorizontalPodAutoscaler<br>● PodDisruptionBudget<br>● CustomResourceDefinition</p>
<h3 id="初期状態のNamespace"><a href="#初期状態のNamespace" class="headerlink" title="初期状態のNamespace"></a>初期状態のNamespace</h3><p>● kube-system<br>・ Kubernetes クラスタのコンポーネントやアドオンがデプロイされる Namespace<br>● kube-public<br>・ 全ユーザが利用できる ConfigMap などを配置する Namespace<br>● kube-node-lease<br>・ Kubernetes Node のハートビート情報を保存するための Lease リソースが保存されている専用の Namespace です。<br>● default<br>・ デフォルトの Namespace、ユーザが任意のリソースを登録するのに使用できます</p>
<h3 id="RBAC（Role-Based-Access-Control）"><a href="#RBAC（Role-Based-Access-Control）" class="headerlink" title="RBAC（Role-Based Access Control）"></a>RBAC（Role-Based Access Control）</h3><p>RBAC は、図 4.2 のようにクラスタ操作に関する権限を Namespace ごとに分けることができるほか、Network Policy と組み合わせることで Namespace 間の通信の制御を行える仕組みです</p>
<p><img src="C:\Users\alston\AppData\Roaming\Typora\typora-user-images\1609324087858.png" alt="1609324087858"></p>
<h3 id="CLI-ツール-kubectl"><a href="#CLI-ツール-kubectl" class="headerlink" title="CLI ツール kubectl"></a>CLI ツール kubectl</h3><p><img src="C:\Users\alston\AppData\Roaming\Typora\typora-user-images\1609324451333.png" alt="1609324451333"></p>
<p>手動：kubectl </p>
<p>プログラム：クライアントライブラリ</p>
<h4 id="認証情報と-Context（config）"><a href="#認証情報と-Context（config）" class="headerlink" title="認証情報と Context（config）"></a>認証情報と Context（config）</h4><p>kubectl が Kubernetes Master と通信する際には、接続先サーバの情報や認証情報などが必要となります。</p>
<p>kubectl は kubeconfig（デフォルトでは<code>~/.kube/config</code>）に書かれている情報を使用して<br>接続を行います。</p>
<p>kubeconfig で具体的に設定を行う部分は、<code>clusters</code> ／ <code>users</code> ／ <code>contexts</code> の 3 種類の配列型です。複数の対象を登録することができます。</p>
<h4 id="kubeconfigのsample"><a href="#kubeconfigのsample" class="headerlink" title="kubeconfigのsample"></a>kubeconfigのsample</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">clusters:</span> <span class="comment"># 接続先クラスタ</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sample-cluster</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://localhost:6443</span></span><br><span class="line"><span class="attr">users:</span> <span class="comment"># 認証情報</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sample-user</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTi...</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTi...</span></span><br><span class="line"><span class="attr">contexts:</span> <span class="comment"># 接続先と認証情報の組み合わせ</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sample-context</span></span><br><span class="line">  <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">sample-cluster</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">sample-user</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">sample-context</span></span><br></pre></td></tr></table></figure>

<p>contexts には、<code>cluster</code> と <code>user</code> のペアと <code>namespace</code> を指定したものを定義します。</p>
<p><img src="C:\Users\alston\AppData\Roaming\Typora\typora-user-images\1609334844802.png" alt="1609334844802"></p>
<h4 id="kubeconfigの設定変更"><a href="#kubeconfigの設定変更" class="headerlink" title="kubeconfigの設定変更"></a>kubeconfigの設定変更</h4><ul>
<li><p>クラスタ（prd-cluster）の定義を追加・変更</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster prd-cluster --server&#x3D;https:&#x2F;&#x2F;localhost:6443</span><br></pre></td></tr></table></figure>
</li>
<li><p>認証情報の定義を追加・変更</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials admin-user \</span><br><span class="line">   --client-certificate=./sample.crt\</span><br><span class="line">   --client-key=./sample.key \</span><br><span class="line">   --embed-certs=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Contextの定義（クラスタcluster／認証情報user／Namespaceを定義）を追加・変更</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context prd-admin \</span><br><span class="line">  --cluster=prd-cluster \</span><br><span class="line">  --user=admin-user \</span><br><span class="line">  --namespace=default</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>kubectl は Context（current-context）を切り替えることにより、複数の環境を複数の権限で操作できる。</p>
<ul>
<li><p>Contextの一覧を表示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config get-contexts</span><br></pre></td></tr></table></figure>
</li>
<li><p>Contextの切り替え <code>use-context</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context prd-admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>現在のContextを表示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config current-context</span><br></pre></td></tr></table></figure>
</li>
<li><p>コマンドの実行ごとにContextを指定することも可能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --context prd-admin get pod</span><br></pre></td></tr></table></figure>



</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/12/29/kind%EF%BC%88Kubernetes%20in%20Docker%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/29/kind%EF%BC%88Kubernetes%20in%20Docker%EF%BC%89/" class="post-title-link" itemprop="url">kind（Kubernetes in Docker）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-29 22:27:29" itemprop="dateCreated datePublished" datetime="2020-12-29T22:27:29+09:00">2020-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-31 21:07:19" itemprop="dateModified" datetime="2020-12-31T21:07:19+09:00">2020-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s%E3%82%AC%E3%82%A4%E3%83%89%E3%83%96%E3%83%83%E3%82%AF/" itemprop="url" rel="index"><span itemprop="name">k8sガイドブック</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="kind（Kubernetes-in-Docker）"><a href="#kind（Kubernetes-in-Docker）" class="headerlink" title="kind（Kubernetes in Docker）"></a>kind（Kubernetes in Docker）</h2><h3 id="kindの仕組み："><a href="#kindの仕組み：" class="headerlink" title="kindの仕組み："></a>kindの仕組み：</h3><p>Docker コンテナを複数個起動し、そのコンテナを Kubernetes Node として利用することで、複数台構成の Kubernetes クラスタを構築します。</p>
<p><img src="C:\Users\alston\AppData\Roaming\Typora\typora-user-images\1609237896022.png" alt="1609237896022"></p>
<p><a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">kindのインストール</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64</span><br><span class="line">chmod +x ./kind</span><br><span class="line">mv ./kind /usr/<span class="built_in">local</span>/bin/kind</span><br></pre></td></tr></table></figure>

<h3 id="クラスター構築："><a href="#クラスター構築：" class="headerlink" title="クラスター構築："></a>クラスター構築：</h3><p>Master3 台・Worker3 台の構成を指定する</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">kindest/node:v1.18.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">kindest/node:v1.18.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">kindest/node:v1.18.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">kindest/node:v1.18.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">kindest/node:v1.18.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">kindest/node:v1.18.2</span></span><br></pre></td></tr></table></figure>

<p>実際にクラスタを構築するには、先ほどの構成設定ファイルを指定して<code>kind create cluster</code>コマンドを実行します。<code>--config</code>は宣言ファイルの指定。 <code>--name</code>はクラスター名の指定。</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/82399">名前は lower case alphanumeric charactersの必要がある</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind create cluster --config kind.yaml --name kindcluster</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Creating cluster &quot;kindcluster&quot; ...</span><br><span class="line"> ✓ Ensuring node image (kindest&#x2F;node:v1.18.2) 🖼 </span><br><span class="line"> ✓ Preparing nodes 📦 📦 📦 📦 📦 📦  </span><br><span class="line"> ✓ Configuring the external load balancer ⚖️️️️️️️️️️️️️ </span><br><span class="line"> ✓ Writing configuration 📜 </span><br><span class="line"> ✓ Starting control-plane 🕹️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️ </span><br><span class="line"> ✓ Installing CNI 🔌 </span><br><span class="line"> ✓ Installing StorageClass 💾 </span><br><span class="line"> ✓ Joining more control-plane nodes 🎮 </span><br><span class="line"> ✓ Joining worker nodes 🚜 </span><br><span class="line">Set kubectl context to &quot;kind-kindcluster&quot;</span><br><span class="line">You can now use your cluster with:</span><br><span class="line"></span><br><span class="line">kubectl cluster-info --context kind-kindcluster</span><br><span class="line"></span><br><span class="line">Thanks for using kind! 😊</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>複数の Kubernetes クラスタを利用している場合には、<code>kubectl</code> の Context を切り替えて利用する必要があります</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config use-context kind-kindcluster</span><br><span class="line">Switched to context <span class="string">&quot;kind-kindcluster&quot;</span>.</span><br></pre></td></tr></table></figure>

<ul>
<li>ローカルマシンで起動している Docker コンテナが Kubernetes Node として認識されています</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME                         STATUS   ROLES    AGE     VERSION</span><br><span class="line">kindcluster-control-plane    Ready    master   3h58m   v1.18.2</span><br><span class="line">kindcluster-control-plane2   Ready    master   3h57m   v1.18.2</span><br><span class="line">kindcluster-control-plane3   Ready    master   3h57m   v1.18.2</span><br><span class="line">kindcluster-worker           Ready    &lt;none&gt;   3h56m   v1.18.2</span><br><span class="line">kindcluster-worker2          Ready    &lt;none&gt;   3h56m   v1.18.2</span><br><span class="line">kindcluster-worker3          Ready    &lt;none&gt;   3h56m   v1.18.2</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Docker コンテナを確認してみると、ノードの台数分コンテナが確認できます。</p>
</li>
<li><p>Kubernetes Master の冗長構成のために使われている HAProxy も確認できます</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                COMMAND                  CREATED             STATUS              PORTS                       NAMES</span><br><span class="line">758a3b2dbb76        kindest&#x2F;haproxy:v20200708-548e36db   &quot;&#x2F;docker-entrypoint.…&quot;   4 hours ago         Up 4 hours          127.0.0.1:42909-&gt;6443&#x2F;tcp   kindcluster-external-load-balancer</span><br><span class="line">6e0965c46027        kindest&#x2F;node:v1.18.2                 &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;entr…&quot;   4 hours ago         Up 4 hours          127.0.0.1:39285-&gt;6443&#x2F;tcp   kindcluster-control-plane3</span><br><span class="line">d60c91ca4926        kindest&#x2F;node:v1.18.2                 &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;entr…&quot;   4 hours ago         Up 4 hours                                      kindcluster-worker2</span><br><span class="line">74df5e7b84cc        kindest&#x2F;node:v1.18.2                 &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;entr…&quot;   4 hours ago         Up 4 hours                                      kindcluster-worker</span><br><span class="line">3bcd661140e3        kindest&#x2F;node:v1.18.2                 &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;entr…&quot;   4 hours ago         Up 4 hours          127.0.0.1:46389-&gt;6443&#x2F;tcp   kindcluster-control-plane</span><br><span class="line">6396d431ea32        kindest&#x2F;node:v1.18.2                 &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;entr…&quot;   4 hours ago         Up 4 hours                                      kindcluster-worker3</span><br><span class="line">b32b5615b46f        kindest&#x2F;node:v1.18.2                 &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;entr…&quot;   4 hours ago         Up 4 hours          127.0.0.1:40325-&gt;6443&#x2F;tcp   kindcluster-control-plane2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>クラスターを取得する</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind get clusters </span><br></pre></td></tr></table></figure>

<ul>
<li>kindclusterを削除する</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind delete cluster --name kindcluster</span><br></pre></td></tr></table></figure>

<h3 id="kindの内部："><a href="#kindの内部：" class="headerlink" title="kindの内部："></a>kindの内部：</h3><p>kind は内部で kubeadmという構築ツールを利用しており、構築時の設定ファイルに対してパッチを当てる<code>kubeadmConfigPatches</code>と<code>kubeadmConfigPatchesJson6902</code>などを利用することで様々なクラスタが構築できます。</p>
<p>ローカルマシンから内部のコンテナへの疎通性を確保するための<code>extraPortMapping</code>などの設定もよく利用する。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/12/16/k8s-A%20quick%20note%20on%20editing%20PODs%20and%20Deployments/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/16/k8s-A%20quick%20note%20on%20editing%20PODs%20and%20Deployments/" class="post-title-link" itemprop="url">k8s-A quick note on editing PODs and Deployments</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-16 22:27:29" itemprop="dateCreated datePublished" datetime="2020-12-16T22:27:29+09:00">2020-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-30 23:10:13" itemprop="dateModified" datetime="2020-12-30T23:10:13+09:00">2020-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s-udemy/" itemprop="url" rel="index"><span itemprop="name">k8s_udemy</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="A-quick-note-on-editing-PODs-and-Deployments"><a href="#A-quick-note-on-editing-PODs-and-Deployments" class="headerlink" title="A quick note on editing PODs and Deployments"></a>A quick note on editing PODs and Deployments</h1><h4 id="Edit-a-POD"><a href="#Edit-a-POD" class="headerlink" title="Edit a POD"></a>Edit a POD</h4><p>Remember, you CANNOT edit specifications of an existing POD other than the below.</p>
<ul>
<li>spec.containers[*].image</li>
<li>spec.initContainers[*].image</li>
<li>spec.activeDeadlineSeconds</li>
<li>spec.tolerations</li>
</ul>
<p>For example you cannot edit the environment variables, service accounts, resource limits (all of which we will discuss later) of a running pod. But if you really want to, you have 2 options:</p>
<ol>
<li>Run the <code>kubectl edit pod &lt;pod name&gt;</code> command.  This will open the pod specification in an editor (vi editor). Then edit the required properties. When you try to save it, you will be denied. This is because you are attempting to edit a field on the pod that is not editable.</li>
</ol>
<p><img src="https://img-a.udemycdn.com/redactor/raw/2019-05-30_14-46-21-89ea56fea6b993ee0ccff1625b13341e.PNG?09BG5AazWSvcs2bxUxT4DsUT--o3zS8vnr8ykoPWZROpeXXzuTMgUrSRwGJ9p2EC8eF0CLDup4_0Mdl2xG22_Jfg1Kg0C4pm063nRD8_oM4I7F3F2T4Gs6pQplcWxcrLhfYXb0vYYNLjCmgrlH7L59aNdE-xxtkyxMLxWlbTUMGMfJge" alt="img"></p>
<p><img src="https://img-a.udemycdn.com/redactor/raw/2019-05-30_14-47-14-07b2638d1a72cb2d5b000c00971f6436.PNG?mh54IFQgm-TfJNMQdLqFkBoZcd3ehECrCg3OnqVOPS7N-jAI2FGOWsXe8c4juYCbvazYMZINlhtvGuVnD1g3A5dmh1UXX5kRPYId-c4ltDSGE9bsRM0l8JaVyVMhB76AJZSoJrdaqnJPbVzyQEOM42NqzT5FSjSK6KjSeWkZqwspzw_f" alt="img"></p>
<p>A copy of the file with your changes is saved in a temporary location as shown above.</p>
<p>You can then delete the existing pod by running the command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod webapp</span><br></pre></td></tr></table></figure>



<p>Then create a new pod with your changes using the temporary file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f &#x2F;tmp&#x2F;kubectl-edit-ccvrq.yaml</span><br></pre></td></tr></table></figure>



<ul>
<li>2.The second option is to extract the pod definition in YAML format to a file using the command</li>
</ul>
<p>使用以yaml格式提取pod的定义并保存到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod webapp -o yaml &gt; my-new-pod.yaml</span><br></pre></td></tr></table></figure>

<p>Then make the changes to the exported file using an editor (vi editor). Save the changes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi my-new-pod.yaml</span><br></pre></td></tr></table></figure>

<p>Then delete the existing pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod webapp</span><br></pre></td></tr></table></figure>

<p>Then create a new pod with the edited file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f my-new-pod.yaml</span><br></pre></td></tr></table></figure>



<h4 id="Edit-Deployments"><a href="#Edit-Deployments" class="headerlink" title="Edit Deployments"></a>Edit Deployments</h4><p>With Deployments you can easily edit any field/property of the POD template. Since the pod template is a child of the deployment specification,  with every change the deployment will automatically delete and create a new pod with the new changes. So if you are asked to edit a property of a POD part of a deployment you may do that simply by running the command</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit deployment my-deployment</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/11/28/go%20context/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/28/go%20context/" class="post-title-link" itemprop="url">go context</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-11-28 22:27:29 / Modified: 11:55:35" itemprop="dateCreated datePublished" datetime="2020-11-28T22:27:29+09:00">2020-11-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Go-Context"><a href="#Go-Context" class="headerlink" title="Go Context"></a>Go Context</h1><blockquote>
<p>《Go语言实战》读书笔记，未完待续，欢迎扫码关注公众号<code>flysnow_org</code>或者网站<a target="_blank" rel="noopener" href="http://www.flysnow.org/">http://www.flysnow.org/</a>，第一时间看后续笔记。觉得有帮助的话，顺手分享到朋友圈吧，感谢支持。</p>
</blockquote>
<p>控制并发有两种经典的方式，一种是WaitGroup，另外一种就是Context，今天我就谈谈Context。</p>
<h2 id="什么是WaitGroup"><a href="#什么是WaitGroup" class="headerlink" title="什么是WaitGroup"></a>什么是WaitGroup</h2><p>WaitGroup以前我们在并发的时候介绍过，它是一种控制并发的方式，它的这种方式是控制多个goroutine同时完成。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		time.Sleep(<span class="number">2</span>*time.Second)</span><br><span class="line">		fmt.Println(<span class="string">&quot;1号完成&quot;</span>)</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		time.Sleep(<span class="number">2</span>*time.Second)</span><br><span class="line">		fmt.Println(<span class="string">&quot;2号完成&quot;</span>)</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(<span class="string">&quot;好了，大家都干完了，放工&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>一个很简单的例子，一定要例子中的2个goroutine同时做完，才算是完成，先做好的就要等着其他未完成的，所有的goroutine要都全部完成才可以。</p>
<p>这是一种控制并发的方式，这种尤其适用于，好多个goroutine协同做一件事情的时候，因为每个goroutine做的都是这件事情的一部分，只有全部的goroutine都完成，这件事情才算是完成，这是等待的方式。</p>
<p>在实际的业务种，我们可能会有这么一种场景：需要我们主动的通知某一个goroutine结束。比如我们开启一个后台goroutine一直做事情，比如监控，现在不需要了，就需要通知这个监控goroutine结束，不然它会一直跑，就泄漏了。</p>
<h2 id="chan通知"><a href="#chan通知" class="headerlink" title="chan通知"></a>chan通知</h2><p>我们都知道一个goroutine启动后，我们是无法控制他的，大部分情况是等待它自己结束，那么如果这个goroutine是一个不会自己结束的后台goroutine呢？比如监控等，会一直运行的。</p>
<p>这种情况化，一直傻瓜式的办法是全局变量，其他地方通过修改这个变量完成结束通知，然后后台goroutine不停的检查这个变量，如果发现被通知关闭了，就自我结束。</p>
<p>这种方式也可以，但是首先我们要保证这个变量在多线程下的安全，基于此，有一种更好的方式：<code>chan + select </code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	stop := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> &lt;-stop:</span><br><span class="line">				fmt.Println(<span class="string">&quot;监控退出，停止了...&quot;</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				fmt.Println(<span class="string">&quot;goroutine监控中...&quot;</span>)</span><br><span class="line">				time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">	fmt.Println(<span class="string">&quot;可以了，通知监控停止&quot;</span>)</span><br><span class="line">	stop&lt;- <span class="literal">true</span></span><br><span class="line">	<span class="comment">//为了检测监控过是否停止，如果没有监控输出，就表示停止了</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例子中我们定义一个<code>stop</code>的chan，通知他结束后台goroutine。实现也非常简单，在后台goroutine中，使用select判断<code>stop</code>是否可以接收到值，如果可以接收到，就表示可以退出停止了；如果没有接收到，就会执行<code>default</code>里的监控逻辑，继续监控，只到收到<code>stop</code>的通知。</p>
<p>有了以上的逻辑，我们就可以在其他goroutine种，给<code>stop</code> chan发送值了，例子中是在main goroutine中发送的，控制让这个监控的goroutine结束。</p>
<p>发送了<code>stop&lt;- true</code>结束的指令后，我这里使用<code>time.Sleep(5 * time.Second)</code>故意停顿5秒来检测我们结束监控goroutine是否成功。如果成功的话，不会再有<code>goroutine监控中...</code>的输出了；如果没有成功，监控goroutine就会继续打印<code>goroutine监控中...</code>输出。</p>
<p>这种chan+select的方式，是比较优雅的结束一个goroutine的方式，不过这种方式也有局限性，如果有很多goroutine都需要控制结束怎么办呢？如果这些goroutine又衍生了其他更多的goroutine怎么办呢？如果一层层的无穷尽的goroutine呢？这就非常复杂了，即使我们定义很多chan也很难解决这个问题，因为goroutine的关系链就导致了这种场景非常复杂。</p>
<h2 id="初识Context"><a href="#初识Context" class="headerlink" title="初识Context"></a>初识Context</h2><p>上面说的这种场景是存在的，比如一个网络请求Request，每个Request都需要开启一个goroutine做一些事情，这些goroutine又可能会开启其他的goroutine。所以我们需要一种可以跟踪goroutine的方案，才可以达到控制他们的目的，这就是Go语言为我们提供的Context，称之为上下文非常贴切，它就是goroutine的上下文。</p>
<p>下面我们就使用Go Context重写上面的示例。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">				fmt.Println(<span class="string">&quot;监控退出，停止了...&quot;</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				fmt.Println(<span class="string">&quot;goroutine监控中...&quot;</span>)</span><br><span class="line">				time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(ctx)</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">	fmt.Println(<span class="string">&quot;可以了，通知监控停止&quot;</span>)</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="comment">//为了检测监控过是否停止，如果没有监控输出，就表示停止了</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重写比较简单，就是把原来的chan <code>stop</code> 换成Context，使用Context跟踪goroutine，以便进行控制，比如结束等。</p>
<p><code>context.Background()</code> 返回一个空的Context，这个空的Context一般用于整个Context树的根节点。然后我们使用<code>context.WithCancel(parent)</code>函数，创建一个可取消的子Context，然后当作参数传给goroutine使用，这样就可以使用这个子Context跟踪这个goroutine。</p>
<p>在goroutine中，使用select调用<code>&lt;-ctx.Done()</code>判断是否要结束，如果接受到值的话，就可以返回结束goroutine了；如果接收不到，就会继续进行监控。</p>
<p>那么是如何发送结束指令的呢？这就是示例中的<code>cancel</code>函数啦，它是我们调用<code>context.WithCancel(parent)</code>函数生成子Context的时候返回的，第二个返回值就是这个取消函数，它是<code>CancelFunc</code>类型的。我们调用它就可以发出取消指令，然后我们的监控goroutine就会收到信号，就会返回结束。</p>
<h2 id="Context控制多个goroutine"><a href="#Context控制多个goroutine" class="headerlink" title="Context控制多个goroutine"></a>Context控制多个goroutine</h2><p>使用Context控制一个goroutine的例子如上，非常简单，下面我们看看控制多个goroutine的例子，其实也比较简单。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	<span class="keyword">go</span> watch(ctx,<span class="string">&quot;【监控1】&quot;</span>)</span><br><span class="line">	<span class="keyword">go</span> watch(ctx,<span class="string">&quot;【监控2】&quot;</span>)</span><br><span class="line">	<span class="keyword">go</span> watch(ctx,<span class="string">&quot;【监控3】&quot;</span>)</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">	fmt.Println(<span class="string">&quot;可以了，通知监控停止&quot;</span>)</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="comment">//为了检测监控过是否停止，如果没有监控输出，就表示停止了</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">watch</span><span class="params">(ctx context.Context, name <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			fmt.Println(name,<span class="string">&quot;监控退出，停止了...&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			fmt.Println(name,<span class="string">&quot;goroutine监控中...&quot;</span>)</span><br><span class="line">			time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>示例中启动了3个监控goroutine进行不断的监控，每一个都使用了Context进行跟踪，当我们使用<code>cancel</code>函数通知取消时，这3个goroutine都会被结束。这就是Context的控制能力，它就像一个控制器一样，按下开关后，所有基于这个Context或者衍生的子Context都会收到通知，这时就可以进行清理操作了，最终释放goroutine，这就优雅的解决了goroutine启动后不可控的问题。</p>
<h2 id="Context接口"><a href="#Context接口" class="headerlink" title="Context接口"></a>Context接口</h2><p>Context的接口定义的比较简洁，我们看下这个接口的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">	Deadline() (deadline time.Time, ok <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">	Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	Err() error</span><br><span class="line"></span><br><span class="line">	Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口共有4个方法，了解这些方法的意思非常重要，这样我们才可以更好的使用他们。</p>
<p><code>Deadline</code>方法是获取设置的截止时间的意思，第一个返回式是截止时间，到了这个时间点，Context会自动发起取消请求；第二个返回值ok==false时表示没有设置截止时间，如果需要取消的话，需要调用取消函数进行取消。</p>
<p><code>Done</code>方法返回一个只读的chan，类型为<code>struct&#123;&#125;</code>，我们在goroutine中，如果该方法返回的chan可以读取，则意味着parent context已经发起了取消请求，我们通过<code>Done</code>方法收到这个信号后，就应该做清理操作，然后退出goroutine，释放资源。</p>
<p><code>Err</code>方法返回取消的错误原因，因为什么Context被取消。</p>
<p><code>Value</code>方法获取该Context上绑定的值，是一个键值对，所以要通过一个Key才可以获取对应的值，这个值一般是线程安全的。</p>
<p>以上四个方法中常用的就是<code>Done</code>了，如果Context取消的时候，我们就可以得到一个关闭的chan，关闭的chan是可以读取的，所以只要可以读取的时候，就意味着收到Context取消的信号了，以下是这个方法的经典用法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Stream</span><span class="params">(ctx context.Context, out <span class="keyword">chan</span>&lt;- Value)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		v, err := DoSomething(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">return</span> ctx.Err()</span><br><span class="line">		<span class="keyword">case</span> out &lt;- v:</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Context接口并不需要我们实现，Go内置已经帮我们实现了2个，我们代码中最开始都是以这两个内置的作为最顶层的partent context，衍生出更多的子Context。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	background = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">	todo       = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Background</span><span class="params">()</span> <span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> background</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TODO</span><span class="params">()</span> <span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> todo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>一个是<code>Background</code>，主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context。</p>
<p>一个是<code>TODO</code>,它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个。</p>
<p>他们两个本质上都是<code>emptyCtx</code>结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> emptyCtx <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Deadline</span><span class="params">()</span> <span class="params">(deadline time.Time, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Done</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>这就是<code>emptyCtx</code>实现Context接口的方法，可以看到，这些方法什么都没做，返回的都是nil或者零值。</p>
<h2 id="Context的继承衍生"><a href="#Context的继承衍生" class="headerlink" title="Context的继承衍生"></a>Context的继承衍生</h2><p>有了如上的根Context，那么是如何衍生更多的子Context的呢？这就要靠context包为我们提供的<code>With</code>系列的函数了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span> <span class="params">(ctx Context, cancel CancelFunc)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, deadline time.Time)</span> <span class="params">(Context, CancelFunc)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span> <span class="params">(Context, CancelFunc)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">Context</span></span></span><br></pre></td></tr></table></figure>

<p>这四个<code>With</code>函数，接收的都有一个partent参数，就是父Context，我们要基于这个父Context创建出子Context的意思，这种方式可以理解为子Context对父Context的继承，也可以理解为基于父Context的衍生。</p>
<p>通过这些函数，就创建了一颗Context树，树的每个节点都可以有任意多个子节点，节点层级可以有任意多个。</p>
<p><code>WithCancel</code>函数，传递一个父Context作为参数，返回子Context，以及一个取消函数用来取消Context。 <code>WithDeadline</code>函数，和<code>WithCancel</code>差不多，它会多传递一个截止时间参数，意味着到了这个时间点，会自动取消Context，当然我们也可以不等到这个时候，可以提前通过取消函数进行取消。</p>
<p><code>WithTimeout</code>和<code>WithDeadline</code>基本上一样，这个表示是超时自动取消，是多少时间后自动取消Context的意思。</p>
<p><code>WithValue</code>函数和取消Context无关，它是为了生成一个绑定了一个键值对数据的Context，这个绑定的数据可以通过<code>Context.Value</code>方法访问到，后面我们会专门讲。</p>
<p>大家可能留意到，前三个函数都返回一个取消函数<code>CancelFunc</code>，这是一个函数类型，它的定义非常简单。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CancelFunc <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>



<p>这就是取消函数的类型，该函数可以取消一个Context，以及这个节点Context下所有的所有的Context，不管有多少层级。</p>
<h2 id="WithValue传递元数据"><a href="#WithValue传递元数据" class="headerlink" title="WithValue传递元数据"></a>WithValue传递元数据</h2><p>通过Context我们也可以传递一些必须的元数据，这些数据会附加在Context上以供使用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> key <span class="keyword">string</span>=<span class="string">&quot;name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	<span class="comment">//附加值</span></span><br><span class="line">	valueCtx:=context.WithValue(ctx,key,<span class="string">&quot;【监控1】&quot;</span>)</span><br><span class="line">	<span class="keyword">go</span> watch(valueCtx)</span><br><span class="line">	time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">	fmt.Println(<span class="string">&quot;可以了，通知监控停止&quot;</span>)</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="comment">//为了检测监控过是否停止，如果没有监控输出，就表示停止了</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">watch</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="comment">//取出值</span></span><br><span class="line">			fmt.Println(ctx.Value(key),<span class="string">&quot;监控退出，停止了...&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">//取出值</span></span><br><span class="line">			fmt.Println(ctx.Value(key),<span class="string">&quot;goroutine监控中...&quot;</span>)</span><br><span class="line">			time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在前面的例子，我们通过传递参数的方式，把<code>name</code>的值传递给监控函数。在这个例子里，我们实现一样的效果，但是通过的是Context的Value的方式。</p>
<p>我们可以使用<code>context.WithValue</code>方法附加一对K-V的键值对，这里Key必须是等价性的，也就是具有可比性；Value值要是线程安全的。</p>
<p>这样我们就生成了一个新的Context，这个新的Context带有这个键值对，在使用的时候，可以通过<code>Value</code>方法读取<code>ctx.Value(key)</code>。</p>
<p>记住，使用WithValue传值，一般是必须的值，不要什么值都传递。</p>
<h2 id="Context-使用原则"><a href="#Context-使用原则" class="headerlink" title="Context 使用原则"></a>Context 使用原则</h2><ol>
<li>不要把Context放在结构体中，要以参数的方式传递</li>
<li>以Context作为参数的函数方法，应该把Context作为第一个参数，放在第一位。</li>
<li>给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO</li>
<li>Context的Value相关方法应该传递必须的数据，不要什么数据都使用这个传递</li>
<li>Context是线程安全的，可以放心的在多个goroutine中传递</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/11/25/k8s-ETCD%20-%20Commands%20(Optional)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/25/k8s-ETCD%20-%20Commands%20(Optional)/" class="post-title-link" itemprop="url">k8s-ETCD - Commands</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-25 22:27:29" itemprop="dateCreated datePublished" datetime="2020-11-25T22:27:29+09:00">2020-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-31 19:37:15" itemprop="dateModified" datetime="2020-12-31T19:37:15+09:00">2020-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s-udemy/" itemprop="url" rel="index"><span itemprop="name">k8s_udemy</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ETCD-Commands-Optional"><a href="#ETCD-Commands-Optional" class="headerlink" title="ETCD - Commands (Optional)"></a>ETCD - Commands (Optional)</h2><p>(Optional) Additional information about ETCDCTL Utility</p>
<p>ETCDCTL is the CLI tool used to interact with（与…相互作用） ETCD.</p>
<p>ETCDCTL can interact with ETCD Server using 2 API versions - Version 2 and Version 3.  By default its set to use Version 2. Each version has different sets of commands.</p>
<ul>
<li><p>For example ETCDCTL version 2 supports the following commands:(ETCDCTL 版本2支持一下的命令)</p>
<p><code>etcdctl backup</code></p>
<p><code>etcdctl cluster-health</code></p>
<p><code>etcdctl mk</code></p>
<p><code>etcdctl mkdir</code></p>
<p>``etcdctl set`</p>
</li>
</ul>
<ul>
<li><p>Whereas（尽管） the commands are different in version 3（版本3中的命令有所不同）</p>
<p><code>etcdctl snapshot save</code></p>
<p><code>etcdctl endpoint health</code></p>
<p><code>etcdctl get</code></p>
<p><code>etcdctl put</code></p>
</li>
</ul>
<ul>
<li>To set the right version of API set the environment variable ETCDCTL_API command（要设置正确的APIversion，请设置环境变量ETCDCTL_API）<code>export ETCDCTL_API=3</code></li>
</ul>
<ul>
<li><p>When API version is not set, it is assumed to be set to version 2. And version 3 commands listed above don’t work. When API version is set to version 3, version 2 commands listed above don’t work.（如果未设置API版本，则假定它设置为版本2。上面列出的版本3命令不起作用。当API版本设置为版本3时，上面列出的版本2命令不起作用。）</p>
</li>
<li><p>Apart from that, you must also specify path to certificate files so that ETCDCTL can authenticate to the ETCD API Server. The certificate files are available in the etcd-master at the following path. We discuss more about certificates in the security section of this course. So don’t worry if this looks complex:（除此之外，还必须指定证书文件的路径，以便ETCDCTL可以向ETCD API服务器进行身份验证。证书文件位于etcd-master中的以下路径中。我们将在本课程的安全性部分讨论有关证书的更多信息。因此，不要担心这看起来是否复杂：）</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--cacert &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt     </span><br><span class="line">--cert &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.crt     </span><br><span class="line">--key &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.key</span><br></pre></td></tr></table></figure>



<p>So for the commands I showed in the previous video to work you must specify the ETCDCTL API version and path to certificate files. Below is the final form:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec etcd-master -n kube-system -- sh -c &quot;ETCDCTL_API&#x3D;3 etcdctl get &#x2F; --prefix --keys-only --limit&#x3D;10 --cacert &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt --cert &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.crt  --key &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.key&quot; </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/11/25/k8s-Imperative%20vs%20Declarative/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/25/k8s-Imperative%20vs%20Declarative/" class="post-title-link" itemprop="url">k8s-Imperative vs Declarative</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-25 22:27:29" itemprop="dateCreated datePublished" datetime="2020-11-25T22:27:29+09:00">2020-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-31 19:36:30" itemprop="dateModified" datetime="2020-12-31T19:36:30+09:00">2020-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s-udemy/" itemprop="url" rel="index"><span itemprop="name">k8s_udemy</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Imperative-vs-Declarative"><a href="#Imperative-vs-Declarative" class="headerlink" title="Imperative vs Declarative"></a>Imperative vs Declarative</h1><h3 id="Certification-Tips-Imperative-Commands-with-Kubectl"><a href="#Certification-Tips-Imperative-Commands-with-Kubectl" class="headerlink" title="Certification Tips - Imperative Commands with Kubectl"></a>Certification Tips - Imperative Commands with Kubectl</h3><p>While you would be working mostly the declarative（声明式） way - using definition files, imperative（命令式） commands can help in getting one time tasks done quickly, as well as generate a definition template easily. This would help save a considerable amount of time during your exams.</p>
<p>Before we begin, familiarize with the two options that can come in handy while working with the below commands:</p>
<p><code>--dry-run</code>: By default as soon as the command is run, the resource will be created. If you simply want to test your command, use the <code>--dry-run=client</code> option. This will not create the resource, instead, tell you whether the resource can be created and if your command is right.(<code>--dry-run</code>:默认情况下，命令运行后将立即创建资源。如果只想测试命令，请使用该<code>--dry-run=client</code>选项，该选项不会创建资源，而是告诉您是否可以创建资源以及您的命令是否正确。)</p>
<p><code>-o yaml</code>: This will output the resource definition in YAML format on the screen.</p>
<p>(在屏幕上以YAML格式输出资源定义)</p>
<p>Use the above two in combination to generate a resource definition file quickly, that you can then modify and create resources as required, instead of creating the files from scratch.(结合使用以上两种方法可以快速生成资源定义文件，然后可以根据需要修改和创建资源，而不必从头开始创建文件。)</p>
<h4 id="POD"><a href="#POD" class="headerlink" title="POD"></a>POD</h4><p><strong>Create an NGINX Pod</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image&#x3D;nginx</span><br></pre></td></tr></table></figure>



<p><strong>Generate POD Manifest YAML file (-o yaml). Don’t create it(–dry-run)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image&#x3D;nginx  --dry-run&#x3D;client -o yaml</span><br></pre></td></tr></table></figure>





<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p><strong>Create a deployment</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment --image&#x3D;nginx nginx</span><br></pre></td></tr></table></figure>



<p><strong>Generate Deployment YAML file (-o yaml). Don’t create it(–dry-run)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment --image&#x3D;nginx nginx --dry-run -o yaml</span><br></pre></td></tr></table></figure>



<p><strong>Generate Deployment with 4 Replicas</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image&#x3D;nginx --replicas&#x3D;4</span><br></pre></td></tr></table></figure>



<p>You can also scale(扩展) a deployment using the <code>kubectl scale</code> command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx --replicas&#x3D;4</span><br></pre></td></tr></table></figure>



<p><strong>Another way to do this is to save the YAML definition to a file.</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image&#x3D;nginx--dry-run&#x3D;client -o yaml &gt; nginx-deployment.yaml</span><br></pre></td></tr></table></figure>

<p>You can then update the YAML file with the replicas or any other field before creating the deployment.</p>
<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><p><strong>Create a Service named redis-service of type ClusterIP to expose pod redis on port 6379</strong>（<strong>创建一个名为redis-service的服务，其类型为ClusterIP，在端口6379上公开pod redis</strong>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose pod redis --port&#x3D;6379 --name redis-service --dry-run&#x3D;client -o yaml</span><br></pre></td></tr></table></figure>

<p>(This will automatically use the pod’s labels as selectors)会自动把pod的label作为selectors</p>
<p>Or</p>
<p><code>kubectl create service clusterip redis --tcp=6379:6379 --dry-run=client -o yaml</code>  (This will not use the pods labels as selectors, instead it will assume selectors as <strong>app=redis.</strong> <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/46191">You cannot pass in selectors as an option.</a> So it does not work very well if your pod has a different label set. So generate the file and modify the selectors before creating the service)</p>
<p><strong>Create a Service named nginx of type NodePort to expose pod nginx’s port 80 on port 30080 on the nodes:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose pod nginx --port&#x3D;80 --name nginx-service --type&#x3D;NodePort --dry-run&#x3D;client -o yaml</span><br></pre></td></tr></table></figure>

<p>(This will automatically use the pod’s labels as selectors, but you cannot specify the node port. You have to generate a definition file and then add the node port in manually before creating the service with the pod.)</p>
<p>Or</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create service nodeport nginx --tcp&#x3D;80:80 --node-port&#x3D;30080 --dry-run&#x3D;client -o yaml</span><br></pre></td></tr></table></figure>

<p>(This will not use the pods labels as selectors)</p>
<p>Both the above commands have their own challenges. While one of it cannot accept a selector the other cannot accept a node port. I would recommend going with the <code>kubectl expose</code> command. If you need to specify a node port, generate a definition file using the same command and manually input the nodeport before creating the service.</p>
<h3 id="Practise"><a href="#Practise" class="headerlink" title="Practise"></a>Practise</h3><ul>
<li><p>Create a new pod called <code>custom-nginx</code> using the <code>nginx</code> image and expose it on <code>container port</code> <code>8080</code></p>
<p><code>kubectl run custom-nginx --image=nginx --port=8080</code></p>
</li>
<li><p>Create a new deployment called <code>redis-deploy</code> in the <code>dev-ns</code> namespace with the <code>redis</code> image. It should have <code>2</code> replicas.</p>
<p><code>kubectl create deployment redis-deploy --image=redis --replicas=2 --namespace=dev-ns</code></p>
<p>或者：</p>
<p>Step 1: Create the deployment YAML file<br><code>kubectl create deployment redis-deploy --image redis --namespace=dev-ns --dry-run=client -o yaml &gt; deploy.yaml</code><br>Step 2: Edit the YAML file and add update the replicas to <code>2</code><br>Step 3: Run <code>kubectl apply -f deploy.yaml</code> to create the deployment in the <code>dev-ns</code> namespace.<br>You can also use <code>kubectl scale deployment or kubectl edit deployment</code> to change the number of replicas once the object has been created.</p>
</li>
<li><p>Create a pod called <code>httpd</code> using the image <code>httpd:alpine</code> in the default namespace. Next, create a service of type <code>ClusterIP</code> by the same name <code>(httpd)</code>. The target port for the service should be <code>80</code>.</p>
<p><code>kubectl run httpd --image=httpd:alpine </code></p>
<p><code>kubectl expose pod httpd --port=80 --name httpd --type=ClusterIP --dry-run=client -o yaml &gt; httpd-service.yaml</code></p>
<p><code>kubectl create -f httpd-service.yaml</code></p>
<p>或者：</p>
<p><code>kubectl run httpd --image=httpd:alpine --port 80 --expose</code></p>
<p>自动创建service和pod</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/11/24/k8s-Microservices-Architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/24/k8s-Microservices-Architecture/" class="post-title-link" itemprop="url">k8s_Microservices_Architecture</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-24 22:29:15" itemprop="dateCreated datePublished" datetime="2020-11-24T22:29:15+09:00">2020-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-30 23:09:49" itemprop="dateModified" datetime="2020-12-30T23:09:49+09:00">2020-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s-udemy/" itemprop="url" rel="index"><span itemprop="name">k8s_udemy</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Microservices-Architecture"><a href="#Microservices-Architecture" class="headerlink" title="Microservices Architecture"></a>Microservices Architecture</h1><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><h4 id="首先创建Pod"><a href="#首先创建Pod" class="headerlink" title="首先创建Pod"></a>首先创建Pod</h4><ul>
<li><p>投票app 的pod</p>
<p><code>voting-app-pod.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">voting-app-pod</span>  <span class="comment">#pod name</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">voting-app</span> <span class="comment">#container name</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">kodekloud/examplevotingapp_vote:v1</span> </span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment">#the port on which the application listens for this voting app</span></span><br><span class="line">          </span><br></pre></td></tr></table></figure>

<p>我们需要用containerPort属性为voting application明确指定port</p>
</li>
<li><p>result app的Pod</p>
<p><code>result-app-pod.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">result-app</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">kodekloud/examplevotingapp_result:v1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>redis的Pod</p>
<p><code>redis-pod.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>postgres的Pod</p>
<p><code>postgres-pod.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">contianers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;postgres&quot;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>worker的Pod</p>
<p><code>worker-app-pod.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">worker-app</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">kodekloud/examplevotingapp_worker:v1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="创建service"><a href="#创建service" class="headerlink" title="创建service"></a>创建service</h4><ul>
<li><p>redis的service (voting-app的Pod连接该service)</p>
<p><code>redis-service.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span> <span class="comment">#voting-app源码里面要连接的数据库为redis，因此这里命名为redis</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-service</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span> <span class="comment">#service暴露给其他连接的port</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">6379</span> <span class="comment">#service要连接的redis的Pod的port</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#link the service to the Pod</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-pod</span> <span class="comment">#redis Pod的label</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>postgres的service （result-app的Pod连接该service）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db</span> <span class="comment">#result-app源码里面连接的数据库名称叫db，因此service要命名为db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgre-service</span> <span class="comment">#随意定义</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5432</span> </span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5432</span> </span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#link the service to the Pod</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgres-pod</span> <span class="comment">#要连接的postgre Pod的labels</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>voting-app的service （用户从外面连接该service）</p>
<p><code>voting-app-service.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">result-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">voting-service</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment">#这里选择NodePort，因为要暴露给外面用户使用</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30004</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#voting-app的Pod的labels</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>result-app的service</p>
<p><code>result-app-service.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">result-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">result-service</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30005</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#result-app的Pod的labels</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="启动Pod和Service"><a href="#启动Pod和Service" class="headerlink" title="启动Pod和Service"></a>启动Pod和Service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods,svc</span><br></pre></td></tr></table></figure>



<h3 id="使用Deployment来创建k8s微服务"><a href="#使用Deployment来创建k8s微服务" class="headerlink" title="使用Deployment来创建k8s微服务"></a>使用Deployment来创建k8s微服务</h3><p><img src="C:\Users\alston\AppData\Roaming\Typora\typora-user-images\1606112620439.png" alt="1606112620439"></p>
<p>用创建一个个Pod的方法并不能实现Pod的扩容（scale up），但选择Deployment能帮助我们实现，replicaSet，rolling update,rollback等功能</p>
<p>将上面例子中pod的定义文件改写成Deployment的定义文件。</p>
<ul>
<li><p>voting-app的Deployment 文件</p>
</li>
<li><p><code>voting-app-deployment.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">voting-app-deploy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">voting-app-deploy</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#pod的labels</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-app-pod</span>  <span class="comment">#pod name</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">voting-app</span> <span class="comment">#container name</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kodekloud/examplevotingapp_vote:v1</span> </span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span> </span><br></pre></td></tr></table></figure>
</li>
<li><p><code>result-app-deployment.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">result-app-deploy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">result-app-deploy</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#pod的labels</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">result-app</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kodekloud/examplevotingapp_result:v1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span> </span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>redis的Deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-deploy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-deploy</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#pod的labels</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-appp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>postgres-deploy.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-deploy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgres-deploy</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#pod的labels</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">             <span class="attr">value:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">             <span class="attr">value:</span> <span class="string">&quot;postgres&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>worker-app-deploy.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">worker-app-deploy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">worker-app-deploy</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#pod的labels</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">worker-app</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kodekloud/examplevotingapp_worker:v1</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>依次创建deployment和Service</p>
<p><code>kubectl create -f  voting-app-deployment.yaml</code></p>
<p><code>kubectl create -f voting-app-service.yaml</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/11/24/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/24/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-24 21:38:36" itemprop="dateCreated datePublished" datetime="2020-11-24T21:38:36+09:00">2020-11-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/11/18/k8s-Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/k8s-Service/" class="post-title-link" itemprop="url">k8s_Service</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-18 22:27:29" itemprop="dateCreated datePublished" datetime="2020-11-18T22:27:29+09:00">2020-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-30 23:08:51" itemprop="dateModified" datetime="2020-12-30T23:08:51+09:00">2020-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s-udemy/" itemprop="url" rel="index"><span itemprop="name">k8s_udemy</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><h2 id="Services-Types"><a href="#Services-Types" class="headerlink" title="Services Types"></a>Services Types</h2><p><img src="https://raw.githubusercontent.com/alstonzero/k8s_Learning/master/pic/service.png"></p>
<ul>
<li>NodePort</li>
<li>ClusterIP: the service create a virtual IP inside the cluster enable communication between different services such as a set of frontend services and a set of backend services.</li>
<li>LoadBalancer</li>
</ul>
<h2 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h2><p>A service can help us by <strong>mapping</strong> a port on the node to a port on the pod.</p>
<p>port的类型</p>
<ul>
<li>tatgetPort：在pod上的web server运行在80端口（pod的port）</li>
<li>port：service自身的port （service有自己的ip地址，也称做clusterIP of the service）</li>
<li>NodePort：在node上的port，用户实际连接的port（有效范围：30000-32767）</li>
</ul>
<p>模板</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30008</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">front-end</span></span><br></pre></td></tr></table></figure>

<p>selector:目的是把service和特定的pod联系到一起。（由于targetPort相同的pod也许会很多，因此使用pod的labels进行选择）</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><ul>
<li><p>首先创建deployment.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span> <span class="string">nginx-2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nignx</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl create -f deployment.yaml</code></p>
</li>
<li><p>创建service</p>
<p><code>service-definition.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30004</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#关键：靠selector来把service和特定pod关联起来 </span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span> <span class="comment">#要关联的pod的metadata.labels的内容</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>selector作用: link the Service to the PODs created by the deployment.</p>
</li>
<li><p>创建service</p>
<p><code>kubectl create -f service-definition.yaml</code></p>
</li>
<li><p>查看当前service</p>
<p><code>kubectl get svc</code></p>
</li>
<li><p>使用minikube的情况下，查看 nodeIP:port 的值 能访问到当前的pod中的服务</p>
<p><code>minikube service myapp-service --url</code></p>
</li>
</ul>
<h2 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h2><ul>
<li>service的默认选项</li>
<li>为node中运行的一组相同的pod提供统一的interface和ip地址</li>
</ul>
<p>frontend server  前端需要和后端通信</p>
<p>backend server 后端需要和redis通信</p>
<p>redis(k-v store)</p>
<p>由于一组相同pod（比如前端），它们的ip address是动态的（pod会挂，会重建），kubernetes service 为这一组pod提供了一个单独的interface去让其他pod能连接这个组里面的pod。</p>
<p>比如，为backend的pods创建一个service，这个serivce会把所有的bakend pods 组成一组并为其他的pod（front end）提供一个单独的interface去连接该backend的service。</p>
<h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><p><code>service-definition.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">back-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">selector:</span> <span class="comment">#通过selector来找到要为哪些pod去创建clusterIP</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span> <span class="comment">#这里同样是pod的labels的内容</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">back-end</span></span><br></pre></td></tr></table></figure>

<p><code>pod-definition.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">back-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,default">
    <link itemprop="mainEntityOfPage" href="https://alstonzero.github.io/2020/11/15/k8s-ReplicaSet-Deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HOU YINGQIAO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyNote">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/15/k8s-ReplicaSet-Deployment/" class="post-title-link" itemprop="url">k8s_ReplicaSet&Deployment</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-15 22:22:48" itemprop="dateCreated datePublished" datetime="2020-11-15T22:22:48+09:00">2020-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-30 23:10:00" itemprop="dateModified" datetime="2020-12-30T23:10:00+09:00">2020-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/k8s-udemy/" itemprop="url" rel="index"><span itemprop="name">k8s_udemy</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ReplicaSet-amp-Deployment"><a href="#ReplicaSet-amp-Deployment" class="headerlink" title="ReplicaSet&amp;Deployment"></a>ReplicaSet&amp;Deployment</h1><h2 id="replica"><a href="#replica" class="headerlink" title="replica"></a>replica</h2><p>创建pod的副本</p>
<p>不会以<code>kubectl delete pod podName</code>的方式而被删除。必须通过replicaset相关命令进行操作。</p>
<h3 id="创建replicaset模板文件"><a href="#创建replicaset模板文件" class="headerlink" title="创建replicaset模板文件"></a>创建replicaset模板文件</h3><ul>
<li>apiVersion: apps/v1</li>
<li>kind: ReplicaSet</li>
<li>metadata: </li>
<li>spec:<ul>
<li>selector<ul>
<li>matchLables: :wq必须和template中metadata里面的label一样</li>
</ul>
</li>
<li>replicas:确定replica的个数。（删除pod后自动添加新的pod。当pod数为replicas指定个数时，不能创建新pod）</li>
<li>template：里面是pod的定义(metadata和spec的部分)</li>
</ul>
</li>
</ul>
<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-replicaset</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">env:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-2</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">production</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>replicaset的selector的matchLabels必须和template的labels下面的内容一致。和replicaset自身labels无关。</p>
<h3 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h3><ul>
<li><p>创建replicaset</p>
<p><code>kubectl create -f replicaset  definition.yaml</code> </p>
</li>
<li><p>查看当前replicaset的个数（注意不是pod的个数）</p>
<p><code>kubectl get replicaset</code></p>
</li>
<li><p>查看当前replicaset的详细信息(replicaSetName指的是具体的replicaset的名字，可通过<code>kubectl get replicaset</code>获得)</p>
<p><code>kubectl describe replicaset replicaSetName</code></p>
</li>
<li><p>get pods 查看具体pod信息</p>
</li>
<li><p>查看创建replicaset所需要的属性信息(replicaSetName指的是具体的replicaset的名字)</p>
<p><code>kubectl explain replicaset replicaSetName</code></p>
</li>
<li><p>删除replicaset </p>
<p><code>kubectl delete replicaset replicasetName</code></p>
<ul>
<li><p><code>--all</code>：删除所有的replicaset</p>
<p><code>kubectl delete replicaset --all</code></p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>编辑指定的replicaset：默认以vim打开并修改replicaset的配置 </p>
<p><code>kubectl edit replicaset replicasetName</code></p>
<p>然后删除原有的旧pods <code>kubectl delete pods --all</code>，replicaset会自动创建新pods</p>
</li>
<li><p><code>scaled</code>命令修改当前replicaset的replica的个数</p>
<p><code>kubectl scale replicaset replicaSetName --replicas=2</code></p>
</li>
</ul>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>目的：为Pods和ReplicaSet提供声明式的更新</p>
<h3 id="创建deployment模板"><a href="#创建deployment模板" class="headerlink" title="创建deployment模板"></a>创建deployment模板</h3><p>和replicaset模板很像，区别是kind为Deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="comment">#必须和template.metadata.lables一致</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-2</span> <span class="comment">#the name of pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span> <span class="comment">#以list形式来定义pod里面的container</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> <span class="comment">#the name of container in the pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>



<h3 id="command"><a href="#command" class="headerlink" title="command"></a>command</h3><ul>
<li><p>create deployment</p>
<p><code>kubectl create -f deployment.yaml</code></p>
</li>
<li><p>查看当前deployment</p>
<p><code>kubectl get deployment</code></p>
</li>
<li><p>查看某一个deployment的具体信息</p>
<p><code>kubectl describe deployment deploymentName</code></p>
</li>
</ul>
<h3 id="Update-amp-Rollout"><a href="#Update-amp-Rollout" class="headerlink" title="Update&amp;Rollout"></a>Update&amp;Rollout</h3><h4 id="Rollout"><a href="#Rollout" class="headerlink" title="Rollout"></a>Rollout</h4><p>追踪deployment的变化并能是我们能够回归到前一个版本</p>
<ul>
<li><p>查看rollout的状态</p>
<p><code>kubectl rollout status deployment/myapp-deployment</code> (myapp-deployment是deployment的name)</p>
</li>
<li><p>show reversion and history of our deployment</p>
<p><code>kubectl rollout history deployment/myapp-deployment</code></p>
</li>
</ul>
<h4 id="Deployment策略："><a href="#Deployment策略：" class="headerlink" title="Deployment策略："></a>Deployment策略：</h4><h4 id="Recreate-和-RollingUpdate-StrategyType-的区别"><a href="#Recreate-和-RollingUpdate-StrategyType-的区别" class="headerlink" title="Recreate 和 RollingUpdate (StrategyType)的区别"></a>Recreate 和 RollingUpdate (StrategyType)的区别</h4><ul>
<li>Recreate策略：先scale down replicaset到0，然后再重新scale up replicaset到预定个数(not default)</li>
<li>RollingUpdate(滚动更新)策略： 每次同时地scale up replicaset 和scale down replicaset(defalult)</li>
</ul>
<h4 id="Rollback-回退"><a href="#Rollback-回退" class="headerlink" title="Rollback (回退)"></a>Rollback (回退)</h4><p>在新版本的pod里发现了问题，要返回到上一个版本</p>
<p>Run the <code>kubectl rollout undo </code>command followed by <code>the name of the deployment</code></p>
<p><code>kubectl rollout undo deployment/myapp-deployment</code></p>
<h3 id="Summarize-Commands"><a href="#Summarize-Commands" class="headerlink" title="Summarize Commands"></a>Summarize Commands</h3><ul>
<li><p>Create deployment</p>
<p><code>kubectl create -f deployment-definition.yml</code></p>
</li>
<li><p>Get 获取所有deployment的信息</p>
<p><code>kubectl get deployments</code></p>
</li>
<li><p>Update 单独升级image（会导致deployment的定义文件中有不同的image配置）(推荐kubectl edit deployment myapp-deployment)</p>
<p><code>kubectl set image deployment/myapp-deployment nginx=nginx:1.9.1</code></p>
</li>
<li><p>回滚的状态 <code>rollout status</code></p>
<p><code>kubectl rollout status deployment/myapp-deployment</code></p>
</li>
<li><p>回滚的history</p>
<p><code>kubectl rollout history deployment/myapp-deployment</code></p>
</li>
<li><p>Rollback</p>
<p><code>kubectl rollout undo deployment/myapp-deployment</code></p>
</li>
</ul>
<h4 id="example-1"><a href="#example-1" class="headerlink" title="example"></a>example</h4><p>1,先create deployment （<code>--record</code>：的意义是记录操作的历史记录）</p>
<p><code>kubectl create -f deployment-defination.yaml --record</code> </p>
<p>2,获取deployment的名字</p>
<p><code>kubectl get deployment</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@master01 work]# kubectl get deployment</span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">myapp-deployment   3/3     3            3           12s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3,使用 <code>kubectl edit deployment myapp-deployment</code>修改image版本为 <code>nginx:1.18</code></p>
<p><code>kubectl edit deployment  myapp-deployment --record</code></p>
<p>4,使用<code>kubectl rollout status deployment myapp-deployment</code>查看rollout状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 work]# kubectl rollout status deployment myapp-deployment</span><br><span class="line">Waiting for deployment &quot;myapp-deployment&quot; rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;myapp-deployment&quot; rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;myapp-deployment&quot; rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;myapp-deployment&quot; rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for deployment &quot;myapp-deployment&quot; rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment &quot;myapp-deployment&quot; successfully rolled out</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5,使用<code>kubectl rollout history deployment myapp-deployment</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 work]# kubectl rollout history deployment myapp-deployment</span><br><span class="line">deployment.apps/myapp-deployment </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         kubectl create --filename=deployment-defination.yaml --record=true</span><br><span class="line">2         kubectl edit deployment/myapp-deployment --record=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6,使用<code>kubectl set image deployment &lt;your_deployment_name&gt; containerName=&lt;image_name&gt;</code>直接设置镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 work]# kubectl set image deployment myapp-deployment nginx=nginx:1.18-perl --record</span><br><span class="line">deployment.apps/myapp-deployment image updated</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看rollout history</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 work]# kubectl rollout history deployment myapp-deployment</span><br><span class="line">deployment.apps&#x2F;myapp-deployment </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         kubectl create --filename&#x3D;deployment-defination.yaml --record&#x3D;true</span><br><span class="line">2         kubectl edit deployment&#x2F;myapp-deployment --record&#x3D;true</span><br><span class="line">3         kubectl set image deployment myapp-deployment nginx&#x3D;nginx:1.18-perl --record&#x3D;true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当前在REVERSION3的位置</p>
<p>7，使用<code>kubectl rollout undo deployment myapp-deployment</code>  进行回退到上个版本,并查看history</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 work]# kubectl rollout undo deployment myapp-deployment </span><br><span class="line">deployment.apps/myapp-deployment rolled back</span><br><span class="line">[root@master01 work]# kubectl rollout history deployment myapp-deployment</span><br><span class="line">deployment.apps/myapp-deployment </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         kubectl create --filename=deployment-defination.yaml --record=true</span><br><span class="line">3         kubectl set image deployment myapp-deployment nginx=nginx:1.18-perl --record=true</span><br><span class="line">4         kubectl edit deployment/myapp-deployment --record=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结果表明：<code>rollout undo</code>（是把当前REVERSION3要回滚到的上一个位置）REVERSION2变成了最新的REVERSION4。换句话说，不是从3到2，而是2变成了4。</p>
<p>8,修改image为一个不存在的version</p>
<p>使用<code>kubectl rollout status deployment myapp-deployment</code>查看：rollout卡住了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@master01 work]# kubectl rollout status deployment myapp-deployment</span><br><span class="line">Waiting for deployment &quot;myapp-deployment&quot; rollout to finish: 1 out of 3 new replicas have been updated...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 work]# kubectl get pods</span><br><span class="line">NAME                                READY   STATUS             RESTARTS   AGE</span><br><span class="line">myapp-deployment-7c8cf9794b-f5qn7   0&#x2F;1     ImagePullBackOff   0          80s</span><br><span class="line">myapp-deployment-ddbb47dd8-68l2m    1&#x2F;1     Running            0          8m13s</span><br><span class="line">myapp-deployment-ddbb47dd8-gv4k9    1&#x2F;1     Running            0          8m22s</span><br><span class="line">myapp-deployment-ddbb47dd8-rg98d    1&#x2F;1     Running            0          8m17s</span><br></pre></td></tr></table></figure>

<p>旧pod还在Running并没有被删除，因此application并没有被影响。</p>
<p><strong>rollout update是安全的</strong>,rollout必须在新pod充分成功创建后，才会删除旧pod</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">HOU YINGQIAO</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/alstonzero" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;alstonzero" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://qiita.com/alstonzero" title="Qiita → https:&#x2F;&#x2F;qiita.com&#x2F;alstonzero" rel="noopener" target="_blank"><i class="qiita fa-fw"></i>Qiita</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://linux.51yip.com/" title="http:&#x2F;&#x2F;linux.51yip.com&#x2F;" rel="noopener" target="_blank">Linux命令手册</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HOU YINGQIAO</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
